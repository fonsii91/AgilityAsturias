<div class="reservations-container">
    <div class="header-main">
        <div>
            <h2>Gestionar Reservas</h2>
            <p class="subtitle">Selecciona una franja horaria para reservar tu clase de Agility.</p>
        </div>
        <!-- ADMIN/STAFF ONLY: Edit Schedule Button -->
        <button *ngIf="['admin', 'staff'].includes(authService.currentUserSignal()?.role || '')"
            class="btn-edit-schedule" (click)="openManageModal()">
            丘뙖잺 Editar Horario
        </button>
    </div>

    <div class="week-selector">
        <button [class.active]="selectedWeek() === 'current'" (click)="toggleWeek('current')">
            Semana Actual
        </button>
        <button [class.active]="selectedWeek() === 'next'" (click)="toggleWeek('next')">
            Semana Siguiente
        </button>
    </div>

    <div *ngFor="let group of groupedSlots()">
        <div class="header-container">
            <h3 class="day-header">
                {{ group.day }}
                <span class="date-label">{{ group.slots[0].date | date:'dd/MM' }}</span>
            </h3>
            <span class="period-badge" [class.morning]="group.period === 'Ma침ana'"
                [class.afternoon]="group.period === 'Tarde'">
                {{ group.period }}
            </span>
        </div>
        <div class="slots-grid">
            <div *ngFor="let slot of group.slots" class="slot-card"
                [class.full]="(slot.currentBookings || 0) >= slot.max_bookings">

                <div class="card-header">
                    <div class="time-badge">
                        <span class="material-icons time-icon">schedule</span>
                        {{ slot.start_time }} - {{ slot.end_time }}
                    </div>
                    <div class="status-indicator"
                        [class.status-green]="(slot.currentBookings || 0) / slot.max_bookings < 0.5"
                        [class.status-orange]="(slot.currentBookings || 0) / slot.max_bookings >= 0.5 && (slot.currentBookings || 0) < slot.max_bookings"
                        [class.status-red]="(slot.currentBookings || 0) >= slot.max_bookings">
                        <span class="status-dot"></span>
                        {{ (slot.currentBookings || 0) >= slot.max_bookings ? 'Completo' : 'Disponible' }}
                    </div>
                </div>

                <div class="availability-section">
                    <div class="progress-labels">
                        <span class="label">Ocupaci칩n</span>
                        <strong class="count">{{ slot.currentBookings }} / {{ slot.max_bookings }}</strong>
                    </div>
                    <div class="progress-track">
                        <div class="progress-fill"
                            [style.width.%]="((slot.currentBookings || 0) / slot.max_bookings) * 100"
                            [class.fill-green]="(slot.currentBookings || 0) / slot.max_bookings < 0.5"
                            [class.fill-orange]="(slot.currentBookings || 0) / slot.max_bookings >= 0.5 && (slot.currentBookings || 0) < slot.max_bookings"
                            [class.fill-red]="(slot.currentBookings || 0) >= slot.max_bookings">
                        </div>
                    </div>
                </div>

                <!-- Attendees Toggle & List -->
                <div class="attendees-section" *ngIf="slot.reservations && slot.reservations.length > 0">
                    <button class="toggle-attendees-btn" (click)="toggleAttendees(slot.id)"
                        [class.active]="expandedSlots().has(slot.id)">
                        <div class="btn-content">
                            <span class="material-icons group-icon">group</span>
                            <span>Ver asistentes ({{ slot.reservations.length }})</span>
                        </div>
                        <span class="material-icons chevron"
                            [class.open]="expandedSlots().has(slot.id)">expand_more</span>
                    </button>

                    <div class="attendees-list-wrapper" [class.expanded]="expandedSlots().has(slot.id)">
                        <div class="attendees-list">
                            <div *ngFor="let res of slot.reservations" class="attendee-card">
                                <div class="attendee-avatar" [class.clickable]="res.userImage"
                                    (click)="enlargeImage(res.userImage)">
                                    <ng-container *ngIf="res.userImage; else defaultAvatar">
                                        <img [src]="res.userImage" alt="User">
                                    </ng-container>
                                    <ng-template #defaultAvatar>
                                        <img src="assets/images/logo.png" alt="Logo" class="default-logo">
                                    </ng-template>
                                </div>
                                <div class="attendee-info">
                                    <span class="attendee-name">{{ res.userName }}</span>
                                    <div class="attendee-dogs">
                                        <span *ngFor="let dog of res.selectedDogs" class="dog-tag">
                                            游
                                            <span *ngIf="dog.image" class="dog-name-link"
                                                (click)="enlargeImage(dog.image)">{{ dog.name }}</span>
                                            <span *ngIf="!dog.image">{{ dog.name || dog }}</span>
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="actions">
                    <!-- Show Cancel button ONLY if booked by current user -->
                    <button *ngIf="slot.isBookedByCurrentUser" class="btn-action btn-cancel-card"
                        (click)="openCancelModal(slot)">
                        Cancelar Reserva
                    </button>

                    <!-- Show Book button if NOT booked by user -->
                    <button *ngIf="!slot.isBookedByCurrentUser" class="btn-action btn-book"
                        [disabled]="(slot.currentBookings || 0) >= slot.max_bookings" (click)="bookSlot(slot)">
                        {{ (slot.currentBookings || 0) >= slot.max_bookings ? 'Sin Plazas' : 'Reservar Plaza' }}
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Booking Modal -->
<div class="modal-backdrop" *ngIf="isModalOpen" (click)="closeModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
        <h3>游늰 Confirmar Reserva</h3>

        <p>쯈uieres reservar plaza para el <strong>{{ selectedSlotForBooking?.day }}</strong> a las <strong>{{
                selectedSlotForBooking?.start_time }}</strong>?</p>

        <div class="dog-selection">
            <p style="margin: 0 0 1rem 0; font-weight: 600; color: #555;">Selecciona los perretes que vendr치n:</p>

            <div *ngIf="myDogs().length === 0" class="no-dogs-warning">
                <p>丘멆잺 No tienes perros registrados.</p>
                <a routerLink="/perfil" (click)="closeModal()">Ir a mi perfil para a침adir uno</a>
            </div>

            <div class="dog-checkboxes">
                <label *ngFor="let dog of myDogs()" class="dog-checkbox">
                    <input type="checkbox" [checked]="selectedDogIds.has(dog.id)" (change)="toggleDogSelection(dog.id)">
                    <span class="dog-label">游 {{ dog.name }}</span>
                </label>
            </div>
        </div>

        <div class="modal-actions">
            <button class="btn-secondary" (click)="closeModal()">Cancelar</button>
            <button class="btn-confirm" (click)="confirmBooking()"
                [disabled]="(myDogs().length > 0 && selectedDogIds.size === 0) || isSubmitting()">
                {{ isSubmitting() ? 'Reservando...' : 'Confirmar Reserva' }}
            </button>
        </div>
    </div>
</div>

<!-- Cancellation Modal -->
<div class="modal-backdrop" *ngIf="isCancelModalOpen" (click)="closeCancelModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
        <h3>游땩 Cancelar Reserva</h3>

        <div class="modal-body">
            <p class="confirm-message">쮼st치s seguro de que quieres cancelar tu reserva para el <strong>{{
                    selectedSlotForCancellation?.day }}</strong> a las <strong>{{
                    selectedSlotForCancellation?.start_time }}</strong>?</p>

            <p class="note warning">Esta acci칩n liberar치 tu plaza inmediatamente.</p>
        </div>

        <div class="modal-actions">
            <button class="btn-secondary" (click)="closeCancelModal()">No, mantener</button>
            <button class="btn-confirm btn-delete-action" (click)="confirmCancellation()" [disabled]="isSubmitting()">
                {{ isSubmitting() ? 'Cancelando...' : 'S칤, cancelar reserva' }}
            </button>
        </div>
    </div>
</div>

<!-- Management Modal (Admin/Staff) -->
<div class="modal-backdrop" *ngIf="isManageModalOpen" (click)="closeManageModal()">
    <div class="modal-content large-modal" (click)="$event.stopPropagation()">
        <div class="modal-header header-light">
            <h3>
                <span class="material-icons header-icon">calendar_month</span>
                Gesti칩n de Horarios
            </h3>
            <button class="btn-icon close-btn" (click)="closeManageModal()" title="Cerrar">
                <span class="material-icons">close</span>
            </button>
        </div>

        <div class="management-body">
            <!-- Form Section -->
            <div class="management-form-card" [class.editing-mode]="editingSlot">
                <div class="form-header-row">
                    <h4 class="section-title card-title">
                        <span class="material-icons indicator-icon">{{ editingSlot ? 'edit_calendar' : 'add_circle'
                            }}</span>
                        {{ editingSlot ? 'Editar Horario Existente' : 'Programar Nuevo Horario' }}
                    </h4>
                    <span class="status-badge" *ngIf="editingSlot">Modo Edici칩n</span>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label>D칤a de la semana</label>
                        <div class="select-wrapper">
                            <select [(ngModel)]="slotForm.day" class="modern-input">
                                <option value="Lunes">Lunes</option>
                                <option value="Martes">Martes</option>
                                <option value="Mi칠rcoles">Mi칠rcoles</option>
                                <option value="Jueves">Jueves</option>
                                <option value="Viernes">Viernes</option>
                                <option value="S치bado">S치bado</option>
                                <option value="Domingo">Domingo</option>
                            </select>
                            <span class="material-icons select-icon">expand_more</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Hora Inicio</label>
                        <div class="input-with-icon">
                            <span class="material-icons input-icon">schedule</span>
                            <input type="time" [(ngModel)]="slotForm.startTime" class="modern-input with-icon">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Hora Fin</label>
                        <div class="input-with-icon">
                            <span class="material-icons input-icon">update</span>
                            <input type="time" [(ngModel)]="slotForm.endTime" class="modern-input with-icon">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Plazas M치x.</label>
                        <div class="input-with-icon">
                            <span class="material-icons input-icon">group</span>
                            <input type="number" [(ngModel)]="slotForm.maxBookings" class="modern-input with-icon"
                                min="1">
                        </div>
                    </div>
                </div>

                <div class="form-actions-row">
                    <button *ngIf="editingSlot" class="btn-text"
                        (click)="editingSlot = null; slotForm = {day: 'Lunes', startTime:'10:00', endTime:'11:00', maxBookings:5}">
                        <span class="material-icons btn-icon-small">cancel</span>
                        Cancelar
                    </button>
                    <button class="btn-primary-action" [class.btn-edit]="editingSlot" (click)="saveSlot()">
                        <span class="material-icons btn-icon-small">{{ editingSlot ? 'save' : 'add' }}</span>
                        {{ editingSlot ? 'Guardar Cambios' : 'A침adir Horario' }}
                    </button>
                </div>
            </div>

            <div class="divider"></div>

            <!-- List Section -->
            <div class="slots-list-section">
                <div class="list-header">
                    <h4 class="section-title card-title">
                        <span class="material-icons indicator-icon">view_list</span>
                        Horarios Configurados
                    </h4>
                    <span class="count-badge">{{ timeSlots().length }} horarios</span>
                </div>

                <div class="slots-list-container">
                    <div *ngFor="let slot of timeSlots()" class="admin-slot-card"
                        [class.highlighted]="editingSlot?.id === slot.id">
                        <div class="slot-card-left">
                            <div class="day-badge-container">
                                <span class="day-badge">{{ slot.day.substring(0, 3) }}</span>
                            </div>
                            <div class="slot-info-main">
                                <span class="time-range">{{ slot.start_time }} - {{ slot.end_time }}</span>
                                <span class="capacity-badge">
                                    <span class="material-icons icon-tiny">person</span>
                                    {{ slot.max_bookings }} plazas max.
                                </span>
                            </div>
                        </div>
                        <div class="slot-actions">
                            <button class="btn-icon-action edit" (click)="editSlot(slot)" title="Editar">
                                <span class="material-icons">edit</span>
                            </button>
                            <button class="btn-icon-action delete" (click)="deleteSlot(slot.id)" title="Eliminar">
                                <span class="material-icons">delete_outline</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Image Modal -->
<div class="modal-backdrop image-modal-backdrop" *ngIf="enlargedImageStr" (click)="closeImage()">
    <div class="modal-content image-modal-content" (click)="closeImage()">
        <button class="btn-icon close-btn" (click)="closeImage()">
            <span class="material-icons">close</span>
        </button>
        <img [src]="enlargedImageStr" alt="Enlarged" class="enlarged-img" (click)="$event.stopPropagation()">
    </div>
</div>