<div class="reservations-container">
    <div class="header-main">
        <div>
            <h2>Gestionar Reservas</h2>
            <p class="subtitle">Selecciona una franja horaria para reservar tu clase de Agility.</p>
        </div>
        <!-- ADMIN/STAFF ONLY: Edit Schedule Button -->
        <button *ngIf="['admin', 'staff'].includes(authService.currentUserSignal()?.role || '')"
            class="btn-edit-schedule" (click)="openManageModal()">
            ‚öôÔ∏è Editar Horario
        </button>
    </div>

    <div class="week-selector">
        <button [class.active]="selectedWeek() === 'current'" (click)="toggleWeek('current')">
            Semana Actual
        </button>
        <button [class.active]="selectedWeek() === 'next'" (click)="toggleWeek('next')">
            Semana Siguiente
        </button>
    </div>

    <div *ngFor="let group of groupedSlots()">
        <div class="header-container">
            <h3 class="day-header">
                {{ group.day }}
                <span class="date-label">{{ group.slots[0].date | date:'dd/MM' }}</span>
            </h3>
            <span class="period-badge" [class.morning]="group.period === 'Ma√±ana'"
                [class.afternoon]="group.period === 'Tarde'">
                {{ group.period }}
            </span>
        </div>
        <div class="slots-grid">
            <div *ngFor="let slot of group.slots" class="slot-card"
                [class.full]="(slot.currentBookings || 0) >= slot.max_bookings">

                <div class="card-header">
                    <div class="time-badge">
                        <span class="material-icons time-icon">schedule</span>
                        {{ slot.start_time }} - {{ slot.end_time }}
                    </div>
                    <div class="status-indicator"
                        [class.status-green]="(slot.currentBookings || 0) / slot.max_bookings < 0.5"
                        [class.status-orange]="(slot.currentBookings || 0) / slot.max_bookings >= 0.5 && (slot.currentBookings || 0) < slot.max_bookings"
                        [class.status-red]="(slot.currentBookings || 0) >= slot.max_bookings">
                        <span class="status-dot"></span>
                        {{ (slot.currentBookings || 0) >= slot.max_bookings ? 'Completo' : 'Disponible' }}
                    </div>
                </div>

                <div class="availability-section">
                    <div class="progress-labels">
                        <span class="label">Ocupaci√≥n</span>
                        <strong class="count">{{ slot.currentBookings }} / {{ slot.max_bookings }}</strong>
                    </div>
                    <div class="progress-track">
                        <div class="progress-fill"
                            [style.width.%]="((slot.currentBookings || 0) / slot.max_bookings) * 100"
                            [class.fill-green]="(slot.currentBookings || 0) / slot.max_bookings < 0.5"
                            [class.fill-orange]="(slot.currentBookings || 0) / slot.max_bookings >= 0.5 && (slot.currentBookings || 0) < slot.max_bookings"
                            [class.fill-red]="(slot.currentBookings || 0) >= slot.max_bookings">
                        </div>
                    </div>
                </div>

                <!-- Attendees Toggle & List -->
                <div class="attendees-section" *ngIf="slot.reservations && slot.reservations.length > 0">
                    <button class="toggle-attendees-btn" (click)="toggleAttendees(slot.id)"
                        [class.active]="expandedSlots().has(slot.id)">
                        <div class="btn-content">
                            <span class="material-icons group-icon">group</span>
                            <span>Ver asistentes ({{ slot.reservations.length }})</span>
                        </div>
                        <span class="material-icons chevron"
                            [class.open]="expandedSlots().has(slot.id)">expand_more</span>
                    </button>

                    <div class="attendees-list-wrapper" [class.expanded]="expandedSlots().has(slot.id)">
                        <div class="attendees-list">
                            <div *ngFor="let res of slot.reservations" class="attendee-card">
                                <div class="attendee-avatar">
                                    {{ res.userName.charAt(0).toUpperCase() }}
                                </div>
                                <div class="attendee-info">
                                    <span class="attendee-name">{{ res.userName }}</span>
                                    <div class="attendee-dogs">
                                        <span *ngFor="let dog of res.selectedDogs" class="dog-tag">
                                            üêæ {{ dog }}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="actions">
                    <!-- Show Cancel button ONLY if booked by current user -->
                    <button *ngIf="slot.isBookedByCurrentUser" class="btn-action btn-cancel-card"
                        (click)="openCancelModal(slot)">
                        Cancelar Reserva
                    </button>

                    <!-- Show Book button if NOT booked by user -->
                    <button *ngIf="!slot.isBookedByCurrentUser" class="btn-action btn-book"
                        [disabled]="(slot.currentBookings || 0) >= slot.max_bookings" (click)="bookSlot(slot)">
                        {{ (slot.currentBookings || 0) >= slot.max_bookings ? 'Sin Plazas' : 'Reservar Plaza' }}
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Booking Modal -->
<div class="modal-backdrop" *ngIf="isModalOpen" (click)="closeModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
        <h3>üìÖ Confirmar Reserva</h3>

        <p>¬øQuieres reservar plaza para el <strong>{{ selectedSlotForBooking?.day }}</strong> a las <strong>{{
                selectedSlotForBooking?.start_time }}</strong>?</p>

        <div class="dog-selection">
            <p style="margin: 0 0 1rem 0; font-weight: 600; color: #555;">Selecciona los perretes que vendr√°n:</p>

            <div *ngIf="myDogs().length === 0" class="no-dogs-warning">
                <p>‚ö†Ô∏è No tienes perros registrados.</p>
                <a routerLink="/perfil" (click)="closeModal()">Ir a mi perfil para a√±adir uno</a>
            </div>

            <div class="dog-checkboxes">
                <label *ngFor="let dog of myDogs()" class="dog-checkbox">
                    <input type="checkbox" [checked]="selectedDogIds.has(dog.id)" (change)="toggleDogSelection(dog.id)">
                    <span class="dog-label">üêæ {{ dog.name }}</span>
                </label>
            </div>
        </div>

        <div class="modal-actions">
            <button class="btn-secondary" (click)="closeModal()">Cancelar</button>
            <button class="btn-confirm" (click)="confirmBooking()"
                [disabled]="(myDogs().length > 0 && selectedDogIds.size === 0) || isSubmitting()">
                {{ isSubmitting() ? 'Reservando...' : 'Confirmar Reserva' }}
            </button>
        </div>
    </div>
</div>

<!-- Cancellation Modal -->
<div class="modal-backdrop" *ngIf="isCancelModalOpen" (click)="closeCancelModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
        <h3>üò¢ Cancelar Reserva</h3>

        <div class="modal-body">
            <p class="confirm-message">¬øEst√°s seguro de que quieres cancelar tu reserva para el <strong>{{
                    selectedSlotForCancellation?.day }}</strong> a las <strong>{{
                    selectedSlotForCancellation?.start_time }}</strong>?</p>

            <p class="note warning">Esta acci√≥n liberar√° tu plaza inmediatamente.</p>
        </div>

        <div class="modal-actions">
            <button class="btn-secondary" (click)="closeCancelModal()">No, mantener</button>
            <button class="btn-confirm btn-delete-action" (click)="confirmCancellation()" [disabled]="isSubmitting()">
                {{ isSubmitting() ? 'Cancelando...' : 'S√≠, cancelar reserva' }}
            </button>
        </div>
    </div>
</div>

<!-- Management Modal (Admin/Staff) -->
<div class="modal-backdrop" *ngIf="isManageModalOpen" (click)="closeManageModal()">
    <div class="modal-content large-modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
            <h3>‚öôÔ∏è Gesti√≥n de Horarios</h3>
            <button class="btn-icon close-btn" (click)="closeManageModal()">
                <span class="material-icons">close</span>
            </button>
        </div>

        <div class="management-body">
            <!-- Form Section -->
            <div class="management-form-card">
                <h4 class="section-title">{{ editingSlot ? '‚úèÔ∏è Editar Horario' : '‚ûï Nuevo Horario' }}</h4>
                <div class="form-grid">
                    <div class="form-group">
                        <label>D√≠a de la semana</label>
                        <div class="select-wrapper">
                            <select [(ngModel)]="slotForm.day">
                                <option value="Lunes">Lunes</option>
                                <option value="Martes">Martes</option>
                                <option value="Mi√©rcoles">Mi√©rcoles</option>
                                <option value="Jueves">Jueves</option>
                                <option value="Viernes">Viernes</option>
                                <option value="S√°bado">S√°bado</option>
                                <option value="Domingo">Domingo</option>
                            </select>
                            <span class="material-icons select-icon">expand_more</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Hora Inicio</label>
                        <input type="time" [(ngModel)]="slotForm.startTime" class="modern-input">
                    </div>

                    <div class="form-group">
                        <label>Hora Fin</label>
                        <input type="time" [(ngModel)]="slotForm.endTime" class="modern-input">
                    </div>

                    <div class="form-group">
                        <label>Plazas M√°x.</label>
                        <input type="number" [(ngModel)]="slotForm.maxBookings" class="modern-input" min="1">
                    </div>
                </div>

                <div class="form-actions-row">
                    <button *ngIf="editingSlot" class="btn-text"
                        (click)="editingSlot = null; slotForm = {day: 'Lunes', startTime:'10:00', endTime:'11:00', maxBookings:5}">
                        Cancelar Edici√≥n
                    </button>
                    <button class="btn-primary-action" (click)="saveSlot()">
                        {{ editingSlot ? 'Guardar Cambios' : 'A√±adir Horario' }}
                    </button>
                </div>
            </div>

            <div class="divider"></div>

            <!-- List Section -->
            <div class="slots-list-section">
                <h4 class="section-title">üìÖ Horarios Actuales</h4>
                <div class="slots-list-container">
                    <div *ngFor="let slot of timeSlots()" class="admin-slot-card">
                        <div class="slot-info-main">
                            <span class="day-badge">{{ slot.day.substring(0, 3) }}</span>
                            <span class="time-range">{{ slot.start_time }} - {{ slot.end_time }}</span>
                        </div>
                        <div class="slot-details">
                            <span class="capacity-badge">
                                <span class="material-icons icon-tiny">group</span>
                                {{ slot.max_bookings }} plazas
                            </span>
                        </div>
                        <div class="slot-actions">
                            <button class="btn-icon-action edit" (click)="editSlot(slot)" title="Editar">
                                <span class="material-icons">edit</span>
                            </button>
                            <button class="btn-icon-action delete" (click)="deleteSlot(slot.id)" title="Eliminar">
                                <span class="material-icons">delete</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>