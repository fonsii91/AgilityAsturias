<div class="perfil-container" *ngIf="authService.userProfileSignal() as user">
    <div class="profile-header">
        <div class="avatar-container">
            <img [src]="previewUrl || user.photoURL || 'assets/default-user.png'" alt="Avatar"
                class="profile-avatar clickable-image" referrerpolicy="no-referrer"
                (click)="openImageModal(previewUrl || user.photoURL || 'assets/default-user.png')">
            <label class="camera-btn" title="Cambiar foto">
                <span class="material-icons-outlined camera-icon">photo_camera</span>
                <input type="file" (change)="onFileSelected($event)" accept="image/*" hidden>
            </label>
        </div>
        <div class="profile-info">
            <div class="name-edit-container">
                <div *ngIf="!isEditingName()" class="name-display">
                    <h2>{{ user.displayName }}</h2>
                    <button class="btn-icon-edit" (click)="toggleEditName()" title="Editar nombre">âœï¸</button>
                </div>

                <div *ngIf="isEditingName()" class="name-input-group">
                    <input type="text" [(ngModel)]="editedName" (keyup.enter)="saveName()" class="edit-name-input">
                    <div class="edit-actions">
                        <button class="btn-check" (click)="saveName()">âœ…</button>
                        <button class="btn-cancel-edit" (click)="toggleEditName()">âŒ</button>
                    </div>
                </div>
            </div>
            <p>{{ user.email }}</p>
            <span class="role-badge" [ngClass]="user.role">{{ user.role | titlecase }}</span>
        </div>
    </div>

    <div class="dogs-section">
        <h3>ğŸ¶ Mis Perretes</h3>
        <p class="section-desc">AÃ±ade aquÃ­ a tus compaÃ±eros de Agility.</p>

        <div class="add-dog-form">
            <input type="text" [(ngModel)]="newDogName" placeholder="Nombre de tu perro..." (keyup.enter)="addDog()">
            <button class="btn-add" (click)="addDog()" [disabled]="!newDogName().trim()">
                AÃ±adir Perro
            </button>
        </div>

        <div class="dogs-list">
            <div *ngIf="dogs().length === 0" class="empty-state">
                <p>AÃºn no has aÃ±adido ningÃºn perro.</p>
            </div>

            <div class="dog-card" *ngFor="let dog of dogs()">
                <div class="dog-icon-container">
                    <img *ngIf="dog.photo_url" [src]="dog.photo_url" alt="{{ dog.name }}"
                        class="dog-avatar clickable-image" referrerpolicy="no-referrer"
                        (click)="openImageModal(dog.photo_url)">
                    <div *ngIf="!dog.photo_url" class="dog-icon">ğŸ•</div>
                    <label class="camera-btn-dog" title="Cambiar foto">
                        <span class="material-icons-outlined camera-icon-small">photo_camera</span>
                        <input type="file" (change)="onDogFileSelected($event, dog.id)" accept="image/*" hidden>
                    </label>
                </div>
                <div class="dog-info">
                    <span class="dog-name">{{ dog.name }}</span>
                </div>
                <button class="btn-delete" (click)="deleteDog(dog.id, dog.name)" title="Eliminar">ğŸ—‘ï¸</button>
            </div>
        </div>
    </div>

    <!-- Image Modal -->
    <div class="modal-overlay image-modal-overlay" *ngIf="imageModalOpen()" (click)="closeImageModal()">
        <button class="close-image-btn" (click)="closeImageModal()">&times;</button>
        <img *ngIf="selectedImage()" [src]="selectedImage()" class="full-size-image" (click)="$event.stopPropagation()">
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal-overlay" *ngIf="deleteModalOpen()" (click)="closeDeleteModal()">
        <div class="modal-content glass-effect" (click)="$event.stopPropagation()">
            <div class="modal-header">
                <h3>Â¿Jubilar a tu perrete? ğŸ˜¢</h3>
                <button class="close-btn" (click)="closeDeleteModal()">&times;</button>
            </div>

            <div class="modal-body">
                <p>
                    Â¿EstÃ¡s seguro de que quieres jubilar a <strong>{{ dogToDelete()?.name }}</strong> de tu perfil?
                </p>
                <p class="note warning">Esta acciÃ³n no se puede deshacer y perderÃ¡s su historial.</p>
            </div>

            <div class="modal-actions">
                <button class="btn-cancel" (click)="closeDeleteModal()">Cancelar</button>
                <button class="btn-confirm btn-delete-action" (click)="confirmDelete()">
                    SÃ­, Eliminar
                </button>
            </div>
        </div>
    </div>
</div>